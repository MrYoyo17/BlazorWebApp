@using TestBlazor.Components.Symbols.Generics
@using TestBlazor.Components.Symbols.Common

<div class="symbol-wrapper-root" style="@GetRootStyle()">
    <MouseOver Context="isOver">
        <div class="rotated-layer" style="@GetRotationStyle()">
            <Selection IsSelected="@IsSelected" Style="width: 100%; height: 100%;" OnClick="OnClick">
                <Alarm State="@AlarmState" IsBlinking="@AlarmBlink">
                    <CrossFilter HasCrossFilter="@HasCrossFilter">
                        <div style="@GetMirrorStyle()">
                            <Enable IsEnabled="@IsEnabled">
                                <Overlay OverlayContent="@OverlayContent">
                                    @ChildContent
                                </Overlay>
                            </Enable>
                        </div>
                    </CrossFilter>
                </Alarm>
            </Selection>
        </div>

        @if (HasCommLoss)
        {
            <div class="static-indicator-left">
                <CommLossIcon />
            </div>
        }
        
        <Settings IsVisible="@isOver" OnClick="@OnSettingsClick" />
    </MouseOver>
</div>

<style>
    /* Ensure generic wrappers fill the selection container */
    ::deep .mouseover-container, 
    ::deep .cross-filter-container,
    .rotated-layer {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }

    .symbol-wrapper-root {
        position: relative;
        display: inline-block;
    }

    .static-indicator-left {
        position: absolute;
        top: -10px;
        left: -10px;
        z-index: 10;
        background: white;
        border-radius: 50%;
        padding: 2px;
        border: 1px solid red;
        line-height: 0;
    }
</style>

@code {
    // Paramètres d'état visuel du symbole
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public bool IsEnabled { get; set; } = true;
    [Parameter] public bool HasCommLoss { get; set; }
    [Parameter] public bool HasCrossFilter { get; set; }
    [Parameter] public int AlarmState { get; set; } // 0=None, 1=Warning, 2=Error
    [Parameter] public bool AlarmBlink { get; set; }
    
    // Paramètres de dimensionnement et rotation
    [Parameter] public int? Size { get; set; } // Gardé pour rétro-compatibilité
    [Parameter] public int? Width { get; set; }
    [Parameter] public int? Height { get; set; }
    [Parameter] public int Rotation { get; set; } = 0;
    
    // Paramètres de symétrie
    [Parameter] public bool MirrorX { get; set; }
    [Parameter] public bool MirrorY { get; set; }

    // RenderFragments
    [Parameter] public RenderFragment? OverlayContent { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    // EventCallbacks
    [Parameter] public EventCallback<MouseEventArgs> OnClick { get; set; }
    [Parameter] public EventCallback OnSettingsClick { get; set; }

    private int ActualWidth => Width ?? Size ?? 100;
    private int ActualHeight => Height ?? Size ?? 100;

    // Style Racine : Dimensions fixes
    private string GetRootStyle()
    {
        return $"width: {ActualWidth}px; height: {ActualHeight}px;";
    }

    // Style Rotation : sur le conteneur interne
    private string GetRotationStyle()
    {
        if (Rotation != 0)
        {
            return $"transform: rotate({Rotation}deg); transform-origin: center;";
        }
        return "";
    }

    // Style Miroir : sur le contenu
    private string GetMirrorStyle()
    {
        var transform = "";
        
        if (MirrorX) transform += " scaleX(-1)";
        if (MirrorY) transform += " scaleY(-1)";
        
        return $"width: 100%; height: 100%;{(string.IsNullOrEmpty(transform) ? "" : $" transform:{transform}; transform-origin: center;")}";
    }
}
