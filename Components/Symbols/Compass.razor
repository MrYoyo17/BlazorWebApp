@using TestBlazor.Services
@inject CompassService CompassService
@implements IDisposable

<div class="compass-container">
    <svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Background Circle -->
        <circle cx="50" cy="50" r="45" stroke="black" stroke-width="2" fill="white" />
        
        <!-- Cardinal Directions -->
        <text x="50" y="15" font-family="Arial" font-size="10" text-anchor="middle">N</text>
        <text x="85" y="53" font-family="Arial" font-size="10" text-anchor="middle">E</text>
        <text x="50" y="92" font-family="Arial" font-size="10" text-anchor="middle">S</text>
        <text x="15" y="53" font-family="Arial" font-size="10" text-anchor="middle">W</text>

        <!-- Rotating Arrow -->
        <g transform="rotate(@CurrentHeading, 50, 50)">
            <path d="M50 20 L60 80 L50 70 L40 80 Z" fill="red" stroke="black" stroke-width="1" />
        </g>
    </svg>
    <div class="compass-text">@CurrentHeading°</div>
</div>

<style>
    .compass-container {
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .compass-text {
        position: absolute;
        bottom: -20px;
        font-weight: bold;
    }
</style>

@using TestBlazor.Models.Symbols

@code {
    [Parameter] public CompassProperties? Symbol { get; set; }
    [Parameter] public int? Heading { get; set; }

    private int CurrentHeading => Symbol?.Heading ?? Heading ?? CompassService.Heading;

    protected override void OnInitialized()
    {
        // S'abonne à l'événement de changement du service.
        // Cela permet au composant de réagir aux mises à jour globales si le paramètre n'est pas fourni.
        CompassService.OnChange += OnCompassChange;
    }

    public void Dispose()
    {
        CompassService.OnChange -= OnCompassChange;
    }

    private async void OnCompassChange()
    {
        // Si le Heading est fourni via paramètre, on ne force pas le refresh ici car c'est le parent qui gère
        if (Heading.HasValue) return;

        await InvokeAsync(StateHasChanged);
    }
}
