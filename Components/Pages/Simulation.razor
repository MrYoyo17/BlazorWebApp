@page "/simulation"
@using TestBlazor.Services
@using TestBlazor.Components.Symbols
@inject SimulationService SimulationService
@implements IDisposable
@rendermode InteractiveServer

<h3>Simulation Temps Réel</h3>

<div class="row">
    <!-- Colonne Gauche : Jauge Moteur -->
    <div class="col-md-4 text-center">
        <h4>Vitesse Moteur</h4>
        <div style="height: 300px; width: 100px; margin: auto;">
            <ProgressBar Value="@SimulationService.MotorSpeed" 
                         Color="@GetColor(SimulationService.MotorSpeed)" 
                         Width="100" Height="300" 
                         AlarmState="@SimulationService.AlarmState" 
                         AlarmBlink="@(SimulationService.AlarmState == 2)" />
        </div>
        <p class="mt-2">@(SimulationService.MotorSpeed.ToString("0")) RPM</p>
    </div>

    <!-- Colonne Milieu : État Vanne -->
    <div class="col-md-4 text-center">
        <h4>État Vanne</h4>
        <div style="height: 150px; width: 150px; margin: auto;">
            <Valve IsSelected="false" 
                   Rotation="@(SimulationService.IsValveOpen ? 90 : 0)" 
                   Width="150" Height="150" />
        </div>
        <p class="mt-2">@(SimulationService.IsValveOpen ? "OUVERTE (90°)" : "FERMÉE (0°)")</p>
    </div>

    <!-- Colonne Droite : Niveau Cuve -->
    <div class="col-md-4 text-center">
        <h4>Niveau Cuve</h4>
        <div style="height: 300px; width: 100px; margin: auto;">
            <ProgressBar Value="@SimulationService.TankLevel" 
                         Color="#17a2b8" 
                         Width="100" Height="300" />
        </div>
        <p class="mt-2">@(SimulationService.TankLevel.ToString("0")) %</p>
    </div>
</div>

<div class="alert alert-info mt-4">
    <p>Cette page affiche des données simulées par <code>SimulationService</code>.</p>
    <ul>
        <li><strong>Vitesse Moteur :</strong> Change aléatoirement. Passe en alarme > 75 (Jaune) et > 90 (Rouge/Clignotant).</li>
        <li><strong>Vanne :</strong> S'ouvre et se ferme aléatoirement.</li>
        <li><strong>Niveau Cuve :</strong> Varie doucement.</li>
    </ul>
</div>

@code {
    protected override void OnInitialized()
    {
        SimulationService.OnChange += OnSimulationChange;
    }

    public void Dispose()
    {
        SimulationService.OnChange -= OnSimulationChange;
    }

    private async void OnSimulationChange()
    {
        await InvokeAsync(StateHasChanged);
    }

    private string GetColor(double value)
    {
        if (value > 90) return "#dc3545"; // Rouge
        if (value > 75) return "#ffc107"; // Jaune
        return "#28a745"; // Vert
    }
}
