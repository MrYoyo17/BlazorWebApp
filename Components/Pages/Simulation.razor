@page "/simulation"
@using TestBlazor.Services
@using TestBlazor.Components.Symbols
@using TestBlazor.Models.Symbols
@inject SimulationService SimulationService
@inject WcfService WcfService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Simulation</PageTitle>

<h1>Tableau de contrôle</h1>

<div class="mt-4 p-3 border rounded bg-light">
    <h3>Test WCF</h3>
    <button class="btn btn-primary" @onclick="TestWcf">Appeler Service WCF (Add 10+20)</button>
    <p class="mt-2">Résultat: @WcfResult</p>
    @if (!string.IsNullOrEmpty(WcfError))
    {
        <div class="alert alert-danger">@WcfError</div>
    }
</div>

<div class="mt-4 p-3 border rounded bg-light">
    <h3>Test UDP Sender (Multicast)</h3>
    <div class="row">
        <div class="col-md-3">
            <label>IP (Multicast/Unicast):</label>
            <input class="form-control" @bind="UdpIp" />
        </div>
        <div class="col-md-2">
            <label>Port:</label>
            <input type="number" class="form-control" @bind="UdpPort" />
        </div>
        <div class="col-md-2">
            <label>Pump 1:</label>
            <input type="number" class="form-control" @bind="UdpPump1" />
        </div>
        <div class="col-md-2">
            <label>Pump 2:</label>
            <input type="number" class="form-control" @bind="UdpPump2" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
             <button class="btn btn-warning w-100" @onclick="SendUdpPacket">Envoyer UDP</button>
        </div>
    </div>
    <p class="mt-2 text-muted">@UdpStatus</p>
</div>

<div class="simulation-view-container">
    @if (MotorFan != null)
    {
        <Fan Symbol="@MotorFan" Width="100" />
        <div style="position: absolute; left: @(MotorFan.X)px; top: @(MotorFan.Y + 110)px; width: 100px; text-align: center;">
            <p>@(MotorFan.Speed.ToString("0")) RPM</p>
        </div>
    }

    @if (InletValve != null)
    {
        <Valve Symbol="@InletValve" Width="100" Height="100" />
        <div style="position: absolute; left: @(InletValve.X)px; top: @(InletValve.Y + 110)px; width: 100px; text-align: center;">
            <p>@(InletValve.IsOpen ? "OUVERTE" : "FERMÉE")</p>
        </div>
    }

    @if (TankLevel != null)
    {
        <ProgressBar Symbol="@TankLevel" Width="80" Height="200" />
        <div style="position: absolute; left: @(TankLevel.X)px; top: @(TankLevel.Y + 210)px; width: 80px; text-align: center;">
            <p>@(TankLevel.Value.ToString("0")) %</p>
        </div>
    }
    
    @if (SimCompass != null)
    {
        <div style="position: absolute; left: @(SimCompass.X)px; top: @(SimCompass.Y)px; width: 150px; height: 150px;">
            <Compass Symbol="@SimCompass" />
        </div>
        <div style="position: absolute; left: @(SimCompass.X)px; top: @(SimCompass.Y + 160)px; width: 150px; text-align: center;">
            <p>@SimCompass.Heading°</p>
        </div>
    }
    
    @if (FeedPump != null)
    {
        <Pump Symbol="@FeedPump" Width="100" />
        <div style="position: absolute; left: @(FeedPump.X)px; top: @(FeedPump.Y + 110)px; width: 100px; text-align: center;">
            <p>@(FeedPump.IsRunning ? "ON" : "OFF")</p>
        </div>
    }
</div>

<style>
    .simulation-view-container {
        position: relative;
        width: 800px;
        height: 600px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        margin-top: 20px;
        overflow: hidden; /* avoid scrollbars if elements stick out slightly */
    }
</style>

<div class="alert alert-info mt-4">
    <p>Cette page affiche des données simulées par <code>SimulationService</code> via des entités.</p>
    <ul>
        <li><strong>Vitesse Moteur :</strong> Change aléatoirement. Passe en alarme > 75 (Jaune) et > 90 (Rouge/Clignotant).</li>
        <li><strong>Vanne :</strong> S'ouvre et se ferme aléatoirement.</li>
        <li><strong>Niveau Cuve :</strong> Varie doucement.</li>
    </ul>
</div>

@code {
    private FanProperties? MotorFan;
    private ValveProperties? InletValve;
    private AnalogDisplayProperties? TankLevel;
    private CompassProperties? SimCompass;
    private PumpProperties? FeedPump;

    protected override void OnInitialized()
    {
        // Récupération des symboles par nom ou type
        MotorFan = SimulationService.Symbols.OfType<FanProperties>().FirstOrDefault(f => f.Name == "Main Fan");
        InletValve = SimulationService.Symbols.OfType<ValveProperties>().FirstOrDefault(v => v.Name == "Inlet Valve");
        TankLevel = SimulationService.Symbols.OfType<AnalogDisplayProperties>().FirstOrDefault(t => t.Name == "Tank Level");
        SimCompass = SimulationService.Symbols.OfType<CompassProperties>().FirstOrDefault(c => c.Name == "Navigation");
        FeedPump = SimulationService.Symbols.OfType<PumpProperties>().FirstOrDefault(p => p.Name == "Feed Pump");

        SimulationService.OnChange += OnSimulationChange;
    }

    public void Dispose()
    {
        SimulationService.OnChange -= OnSimulationChange;
    }

    private async void OnSimulationChange()
    {
        // Re-render
        await InvokeAsync(StateHasChanged);
    }

    private string GetColor(double value)
    {
        if (value > 90) return "#dc3545"; // Rouge
        if (value > 75) return "#ffc107"; // Jaune
        return "#28a745"; // Vert
    }

    // WCF Test
    private string WcfResult = "-";
    private string WcfError = "";

    private async Task TestWcf()
    {
        WcfResult = "Appel en cours...";
        WcfError = "";
        try
        {
            var res = await WcfService.AddAsync(10, 20);
            WcfResult = res.ToString();
        }
        catch (Exception ex)
        {
            WcfError = $"Erreur: {ex.Message} (Normal si pas de serveur)";
            WcfResult = "Erreur";
        }
    }

    // UDP Sender
    @inject IUdpSenderService UdpSenderService
    private string UdpIp = "239.0.0.1";
    private int UdpPort = 11000;
    private double UdpPump1 = 50;
    private double UdpPump2 = 50;
    private string UdpStatus = "";

    private async Task SendUdpPacket()
    {
        UdpStatus = "Envoi...";
        try
        {
            var data = new TestBlazor.Models.UdpPacketData
            {
                PacketId = new Random().Next(1000),
                Pump1Value = UdpPump1,
                Pump2Value = UdpPump2,
                AlarmState = 0,
                Input1Value = 0
            };
            
            await UdpSenderService.SendPacketAsync(UdpIp, UdpPort, data);
            UdpStatus = $"Paquet envoyé à {UdpIp}:{UdpPort}";
        }
        catch (Exception ex)
        {
             UdpStatus = $"Erreur: {ex.Message}";
        }
    }
}
