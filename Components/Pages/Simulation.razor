@page "/simulation"
@using TestBlazor.Services
@using TestBlazor.Components.Symbols
@using TestBlazor.Models.Symbols
@inject SimulationService SimulationService
@inject WcfService WcfService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Simulation</PageTitle>

<h1>Tableau de contrôle</h1>

<div class="mt-4 p-3 border rounded bg-light">
    <h3>Test WCF</h3>
    <button class="btn btn-primary" @onclick="TestWcf">Appeler Service WCF (Add 10+20)</button>
    <p class="mt-2">Résultat: @WcfResult</p>
    @if (!string.IsNullOrEmpty(WcfError))
    {
        <div class="alert alert-danger">@WcfError</div>
    }
</div>

<div class="row">
    <!-- Colonne Gauche : Jauge Moteur -->
    <div class="col-md-3 text-center">
        <h4>Vitesse Moteur</h4>
        @if (MotorFan != null)
        {
            <div style="height: 300px; width: 100px; margin: auto;">
                <ProgressBar Symbol="@MotorFan"
                             Value="@MotorFan.Speed" 
                             Color="@GetColor(MotorFan.Speed)" 
                             Width="100" Height="300" />
            </div>
            <p class="mt-2">@(MotorFan.Speed.ToString("0")) RPM</p>
        }
        else
        {
            <p>Chargement...</p>
        }
    </div>

    <!-- Colonne Milieu : État Vanne -->
    <div class="col-md-3 text-center">
        <h4>État Vanne</h4>
        @if (InletValve != null)
        {
            <div style="height: 150px; width: 150px; margin: auto;">
                <Valve Symbol="@InletValve"
                       Width="150" Height="150" />
            </div>
            <p class="mt-2">@(InletValve.IsOpen ? "OUVERTE (90°)" : "FERMÉE (0°)")</p>
        }
        else
        {
            <p>Chargement...</p>
        }
    </div>

    <!-- Colonne Droite : Niveau Cuve -->
    <div class="col-md-3 text-center">
        <h4>Niveau Cuve</h4>
        @if (TankLevel != null)
        {
            <div style="height: 300px; width: 100px; margin: auto;">
                <ProgressBar Symbol="@TankLevel"
                             Value="@TankLevel.Value" 
                             Color="#17a2b8" 
                             Width="100" Height="300" />
            </div>
            <p class="mt-2">@(TankLevel.Value.ToString("0")) %</p>
        }
        else
        {
            <p>Chargement...</p>
        }
    </div>

    <!-- Colonne Compass -->
    <div class="col-md-3 text-center">
        <h4>Compass</h4>
        @if (SimCompass != null)
        {
            <div style="height: 150px; width: 150px; margin: auto;">
                <Compass Symbol="@SimCompass" />
            </div>
            <p class="mt-2">@SimCompass.Heading°</p>
        }
        else
        {
            <p>Chargement...</p>
        }
    </div>
</div>

<div class="alert alert-info mt-4">
    <p>Cette page affiche des données simulées par <code>SimulationService</code> via des entités.</p>
    <ul>
        <li><strong>Vitesse Moteur :</strong> Change aléatoirement. Passe en alarme > 75 (Jaune) et > 90 (Rouge/Clignotant).</li>
        <li><strong>Vanne :</strong> S'ouvre et se ferme aléatoirement.</li>
        <li><strong>Niveau Cuve :</strong> Varie doucement.</li>
    </ul>
</div>

@code {
    private FanProperties? MotorFan;
    private ValveProperties? InletValve;
    private AnalogDisplayProperties? TankLevel;
    private CompassProperties? SimCompass;

    protected override void OnInitialized()
    {
        // Récupération des symboles par nom ou type
        MotorFan = SimulationService.Symbols.OfType<FanProperties>().FirstOrDefault(f => f.Name == "Main Fan");
        InletValve = SimulationService.Symbols.OfType<ValveProperties>().FirstOrDefault(v => v.Name == "Inlet Valve");
        TankLevel = SimulationService.Symbols.OfType<AnalogDisplayProperties>().FirstOrDefault(t => t.Name == "Tank Level");
        SimCompass = SimulationService.Symbols.OfType<CompassProperties>().FirstOrDefault(c => c.Name == "Navigation");

        SimulationService.OnChange += OnSimulationChange;
    }

    public void Dispose()
    {
        SimulationService.OnChange -= OnSimulationChange;
    }

    private async void OnSimulationChange()
    {
        // Re-render
        await InvokeAsync(StateHasChanged);
    }

    private string GetColor(double value)
    {
        if (value > 90) return "#dc3545"; // Rouge
        if (value > 75) return "#ffc107"; // Jaune
        return "#28a745"; // Vert
    }

    // WCF Test
    private string WcfResult = "-";
    private string WcfError = "";

    private async Task TestWcf()
    {
        WcfResult = "Appel en cours...";
        WcfError = "";
        try
        {
            var res = await WcfService.AddAsync(10, 20);
            WcfResult = res.ToString();
        }
        catch (Exception ex)
        {
            WcfError = $"Erreur: {ex.Message} (Normal si pas de serveur)";
            WcfResult = "Erreur";
        }
    }
}
