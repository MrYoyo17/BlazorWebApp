@page "/supervision"
@using TestBlazor.Components.Symbols
@using TestBlazor.Components.Symbols.Generics
@rendermode InteractiveServer

<PageTitle>Supervision</PageTitle>

<h1>Supervision Barrage Hydraulique</h1>

<div class="controls mb-4">
    <div class="card p-3">
        <h4>Control Panel</h4>
        <div class="d-flex gap-3 align-items-center">
            <div>
                <strong>Selected:</strong> @(SelectedId ?? "None")
            </div>
            <div class="control-group">
                <label>Alarme (Sélection)</label>
                <div class="btn-group">
                    <button class="btn @(GetAlarmState(SelectedId) == 0 ? "btn-primary" : "btn-secondary")" @onclick="() => SetAlarmState(0)">None</button>
                    <button class="btn @(GetAlarmState(SelectedId) == 1 ? "btn-warning" : "btn-secondary")" @onclick="() => SetAlarmState(1)">Warning</button>
                    <button class="btn @(GetAlarmState(SelectedId) == 2 ? "btn-danger" : "btn-secondary")" @onclick="() => SetAlarmState(2)">Error</button>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="alarmBlink" checked="@GetAlarmBlink(SelectedId)" @onchange="@(e => SetAlarmBlink((bool)(e.Value ?? false)))">
                    <label class="form-check-label" for="alarmBlink">Clignoter</label>
                </div>
            </div>
            
            <div class="control-group">
                <label>Rotation</label>
                <input type="range" class="form-range" min="0" max="360" step="90" value="@GetRotation(SelectedId)" @oninput="@(e => SetRotation(int.Parse(e.Value?.ToString() ?? "0")))" />
                <span>@GetRotation(SelectedId)°</span>
            </div>
            <button class="btn btn-primary" @onclick="ToggleOverlay" disabled="@(SelectedId == null)">Toggle Overlay</button>
            <button class="btn btn-secondary" @onclick="ToggleEnable" disabled="@(SelectedId == null)">Toggle Enable</button>
            <button class="btn btn-danger" @onclick="ToggleCommLoss" disabled="@(SelectedId == null)">Toggle Comm Loss</button>
            <button class="btn btn-warning" @onclick="ToggleCrossFilter" disabled="@(SelectedId == null)">Toggle Cross Filter</button>
        </div>
    </div>
</div>

<div class="supervision-grid">
    <div class="symbol-group">
        <h3>Pumps (Resized & Mirrored)</h3>
        <Pump IsSelected="@(SelectedId == "pump1")" IsEnabled="@IsEnable("pump1")" HasCommLoss="@HasCommLoss("pump1")" HasCrossFilter="@HasCrossFilter("pump1")" AlarmState="@GetAlarmState("pump1")" AlarmBlink="@GetAlarmBlink("pump1")" OnClick="@(() => Select("pump1"))" OnSettingsClick="@(() => OpenSettings("pump1"))" OverlayContent="@GetOverlay("pump1")" Rotation="@GetRotation("pump1")" />
        <div style="margin-top: 10px;">
             <!-- Pump 2: Resized 150x50, Mirrored X -->
            <Pump Width="150" Height="50" MirrorX="true" IsSelected="@(SelectedId == "pump2")" IsEnabled="@IsEnable("pump2")" HasCommLoss="@HasCommLoss("pump2")" HasCrossFilter="@HasCrossFilter("pump2")" AlarmState="@GetAlarmState("pump2")" AlarmBlink="@GetAlarmBlink("pump2")" OnClick="@(() => Select("pump2"))" OnSettingsClick="@(() => OpenSettings("pump2"))" OverlayContent="@GetOverlay("pump2")" Rotation="@GetRotation("pump2")" />
        </div>
    </div>

    <div class="symbol-group">
        <h3>Valves (Rotated Selection)</h3>
        <Valve IsSelected="@(SelectedId == "valve1")" IsEnabled="@IsEnable("valve1")" HasCommLoss="@HasCommLoss("valve1")" HasCrossFilter="@HasCrossFilter("valve1")" AlarmState="@GetAlarmState("valve1")" AlarmBlink="@GetAlarmBlink("valve1")" OnClick="@(() => Select("valve1"))" OnSettingsClick="@(() => OpenSettings("valve1"))" OverlayContent="@GetOverlay("valve1")" Rotation="@GetRotation("valve1")" />
        <Valve Size="80" IsSelected="@(SelectedId == "valve2")" IsEnabled="@IsEnable("valve2")" HasCommLoss="@HasCommLoss("valve2")" HasCrossFilter="@HasCrossFilter("valve2")" AlarmState="@GetAlarmState("valve2")" AlarmBlink="@GetAlarmBlink("valve2")" OnClick="@(() => Select("valve2"))" OnSettingsClick="@(() => OpenSettings("valve2"))" OverlayContent="@GetOverlay("valve2")" Rotation="@(GetRotation("valve2") == 0 ? 45 : GetRotation("valve2"))" />
    </div>

    <div class="symbol-group">
        <h3>Motors</h3>
        <Moteur IsSelected="@(SelectedId == "motor1")" IsEnabled="@IsEnable("motor1")" HasCommLoss="@HasCommLoss("motor1")" HasCrossFilter="@HasCrossFilter("motor1")" AlarmState="@GetAlarmState("motor1")" AlarmBlink="@GetAlarmBlink("motor1")" OnClick="@(() => Select("motor1"))" OnSettingsClick="@(() => OpenSettings("motor1"))" OverlayContent="@GetOverlay("motor1")" Rotation="@GetRotation("motor1")" />
        <Moteur IsSelected="@(SelectedId == "motor2")" IsEnabled="@IsEnable("motor2")" HasCommLoss="@HasCommLoss("motor2")" HasCrossFilter="@HasCrossFilter("motor2")" AlarmState="@GetAlarmState("motor2")" AlarmBlink="@GetAlarmBlink("motor2")" OnClick="@(() => Select("motor2"))" OnSettingsClick="@(() => OpenSettings("motor2"))" OverlayContent="@GetOverlay("motor2")" Rotation="@(GetRotation("motor2") == 0 ? 90 : GetRotation("motor2"))" />
    </div>

    <div class="symbol-group">
        <h3>Fans</h3>
        <Fan IsSelected="@(SelectedId == "fan1")" IsEnabled="@IsEnable("fan1")" HasCommLoss="@HasCommLoss("fan1")" HasCrossFilter="@HasCrossFilter("fan1")" AlarmState="@GetAlarmState("fan1")" AlarmBlink="@GetAlarmBlink("fan1")" OnClick="@(() => Select("fan1"))" OnSettingsClick="@(() => OpenSettings("fan1"))" OverlayContent="@GetOverlay("fan1")" Rotation="@GetRotation("fan1")" />
        <Fan Size="120" IsSelected="@(SelectedId == "fan2")" IsEnabled="@IsEnable("fan2")" HasCommLoss="@HasCommLoss("fan2")" HasCrossFilter="@HasCrossFilter("fan2")" AlarmState="@GetAlarmState("fan2")" AlarmBlink="@GetAlarmBlink("fan2")" OnClick="@(() => Select("fan2"))" OnSettingsClick="@(() => OpenSettings("fan2"))" OverlayContent="@GetOverlay("fan2")" Rotation="@(GetRotation("fan2") == 0 ? -45 : GetRotation("fan2"))" />
    </div>

    <div class="symbol-group">
        <h3>Compass</h3>
        <div style="width: 120px; height: 120px;">
            <Compass />
        </div>
    </div>

    <div class="symbol-group">
        <h3>Inputs & Progress</h3>
        <InputSymbol Label="Level" Unit="%" @bind-Value="ProgressValue" IsSelected="@(SelectedId == "input1")" IsEnabled="@IsEnable("input1")" HasCommLoss="@HasCommLoss("input1")" HasCrossFilter="@HasCrossFilter("input1")" AlarmState="@GetAlarmState("input1")" AlarmBlink="@GetAlarmBlink("input1")" OnClick="@(() => Select("input1"))" OnSettingsClick="@(() => OpenSettings("input1"))" OverlayContent="@GetOverlay("input1")" Rotation="@GetRotation("input1")" />
        
        <ProgressBar Value="@ProgressValue" Width="60" Height="150" IsSelected="@(SelectedId == "progress1")" IsEnabled="@IsEnable("progress1")" HasCommLoss="@HasCommLoss("progress1")" HasCrossFilter="@HasCrossFilter("progress1")" AlarmState="@GetAlarmState("progress1")" AlarmBlink="@GetAlarmBlink("progress1")" OnClick="@(() => Select("progress1"))" OnSettingsClick="@(() => OpenSettings("progress1"))" OverlayContent="@GetOverlay("progress1")" Rotation="@GetRotation("progress1")" />
    </div>
</div>

<ConfirmationModal IsVisible="@IsModalVisible" Title="Settings Confirmation" Message="@($"Are you sure you want to configure {TargetSettingsId}?")" OnConfirm="@OnConfirmSettings" OnCancel="@OnCancelSettings" />

<style>
    .supervision-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .symbol-group {
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .overlay-text {
        background-color: rgba(255, 255, 0, 0.7);
        padding: 2px 5px;
        border-radius: 3px;
        font-weight: bold;
    }
</style>

@code {
    private string? SelectedId { get; set; }
    private HashSet<string> DisabledIds { get; set; } = new();
    private HashSet<string> OverlayIds { get; set; } = new();
    private HashSet<string> CommLossIds { get; set; } = new();
    private HashSet<string> CrossFilterIds { get; set; } = new();

    private double ProgressValue { get; set; } = 50;

    private bool IsModalVisible { get; set; }
    private string? TargetSettingsId { get; set; }

    private Dictionary<string, int> AlarmStates { get; set; } = new();
    private Dictionary<string, bool> AlarmBlinks { get; set; } = new();
    private Dictionary<string, int> Rotations { get; set; } = new();

    private void Select(string id)
    {
        SelectedId = id;
    }

    private bool IsEnable(string id) => !DisabledIds.Contains(id);
    private bool HasCommLoss(string id) => CommLossIds.Contains(id);
    private bool HasCrossFilter(string id) => CrossFilterIds.Contains(id);
    
    private int GetAlarmState(string? id) => id != null && AlarmStates.TryGetValue(id, out int state) ? state : 0;
    private bool GetAlarmBlink(string? id) => id != null && AlarmBlinks.TryGetValue(id, out bool blink) ? blink : false;
    private int GetRotation(string? id) => id != null && Rotations.TryGetValue(id, out int rot) ? rot : 0;

    private void SetAlarmState(int state)
    {
        if (SelectedId != null)
        {
            AlarmStates[SelectedId] = state;
        }
    }

    private void SetAlarmBlink(bool blink)
    {
        if (SelectedId != null)
        {
            AlarmBlinks[SelectedId] = blink;
        }
    }

    private void SetRotation(int rotation)
    {
         if (SelectedId != null)
        {
            Rotations[SelectedId] = rotation;
        }
    }
    
    // Existing methods...
    private RenderFragment? GetOverlay(string id)
    {
        if (OverlayIds.Contains(id))
        {
            return @<div class="overlay-text">Info</div>;
        }
        return null;
    }

    private void ToggleOverlay()
    {
        if (SelectedId != null)
        {
            if (OverlayIds.Contains(SelectedId))
            {
                OverlayIds.Remove(SelectedId);
            }
            else
            {
                OverlayIds.Add(SelectedId);
            }
        }
    }

    private void ToggleEnable()
    {
        if (SelectedId != null)
        {
            if (DisabledIds.Contains(SelectedId))
            {
                DisabledIds.Remove(SelectedId);
            }
            else
            {
                DisabledIds.Add(SelectedId);
            }
        }
    }

    private void ToggleCommLoss()
    {
        if (SelectedId != null)
        {
            if (CommLossIds.Contains(SelectedId))
            {
                CommLossIds.Remove(SelectedId);
            }
            else
            {
                CommLossIds.Add(SelectedId);
            }
        }
    }

    private void ToggleCrossFilter()
    {
        if (SelectedId != null)
        {
            if (CrossFilterIds.Contains(SelectedId))
            {
                CrossFilterIds.Remove(SelectedId);
            }
            else
            {
                CrossFilterIds.Add(SelectedId);
            }
        }
    }

    // Settings Logic
    private void OpenSettings(string id)
    {
        TargetSettingsId = id;
        IsModalVisible = true;
    }

    private void OnConfirmSettings()
    {
        // Logic for confirmation can be added here
        Console.WriteLine($"Settings confirmed for {TargetSettingsId}");
        IsModalVisible = false;
        TargetSettingsId = null;
    }

    private void OnCancelSettings()
    {
        IsModalVisible = false;
        TargetSettingsId = null;
    }
}
