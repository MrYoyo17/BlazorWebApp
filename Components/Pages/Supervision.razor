@page "/supervision"
@using TestBlazor.Components.Symbols
@using TestBlazor.Components.Symbols.Generics
@using TestBlazor.Models.Symbols
@using TestBlazor.Services
@using TestBlazor.Models
@rendermode InteractiveServer
@implements IDisposable
@inject IUdpListenerService UdpService

<PageTitle>Supervision</PageTitle>

<h1>Supervision Barrage Hydraulique</h1>

<div class="controls mb-4">
    <div class="card p-3">
        <h4>Control Panel</h4>
        <div class="d-flex gap-3 align-items-center">
            <div>
                <strong>Selected:</strong> @(SelectedSymbol?.Name ?? "None")
            </div>
            <div class="control-group">
                <label>Alarme (Sélection)</label>
                <div class="btn-group">
                    <button class="btn @(GetAlarmState() == 0 ? "btn-primary" : "btn-secondary")" @onclick="() => SetAlarmState(0)">None</button>
                    <button class="btn @(GetAlarmState() == 1 ? "btn-warning" : "btn-secondary")" @onclick="() => SetAlarmState(1)">Warning</button>
                    <button class="btn @(GetAlarmState() == 2 ? "btn-danger" : "btn-secondary")" @onclick="() => SetAlarmState(2)">Error</button>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="alarmBlink" checked="@GetAlarmBlink()" @onchange="@(e => SetAlarmBlink((bool)(e.Value ?? false)))">
                    <label class="form-check-label" for="alarmBlink">Clignoter</label>
                </div>
            </div>
            
            <div class="control-group">
                <label>Rotation</label>
                <input type="range" class="form-range" min="0" max="360" step="15" value="@(SelectedSymbol?.Rotation ?? 0)" @oninput="@(e => { if(SelectedSymbol != null) SelectedSymbol.Rotation = int.Parse(e.Value?.ToString() ?? "0"); })" />
                <span>@(SelectedSymbol?.Rotation ?? 0)°</span>
            </div>
            <button class="btn btn-secondary" @onclick="ToggleEnable" disabled="@(SelectedSymbol == null)">Toggle Enable</button>
            <button class="btn btn-danger" @onclick="ToggleCommLoss" disabled="@(SelectedSymbol == null)">Toggle Comm Loss</button>
            <button class="btn btn-warning" @onclick="ToggleCrossFilter" disabled="@(SelectedSymbol == null)">Toggle Cross Filter</button>
        </div>
    </div>
</div>

<div class="supervision-grid">
    <div class="symbol-group">
        <h3>Pumps</h3>
        <Pump Symbol="@Pump1" OnClick="@(() => Select(Pump1))" OnSettingsClick="@(() => OpenSettings(Pump1))" />
        <div style="margin-top: 10px;">
             <!-- Pump 2: Resized 150x50, Mirrored X (Done in C# init) -->
            <Pump Symbol="@Pump2" Width="150" Height="50" OnClick="@(() => Select(Pump2))" OnSettingsClick="@(() => OpenSettings(Pump2))" />
        </div>
    </div>

    <div class="symbol-group">
        <h3>Valves</h3>
        <Valve Symbol="@Valve1" OnClick="@(() => Select(Valve1))" OnSettingsClick="@(() => OpenSettings(Valve1))" />
        <Valve Symbol="@Valve2" Size="80" OnClick="@(() => Select(Valve2))" OnSettingsClick="@(() => OpenSettings(Valve2))" />
    </div>

    <div class="symbol-group">
        <h3>Motors</h3>
        <!-- Moteur uses generic wrapper internally but we pass specific properties -->
        <Moteur Symbol="@Motor1" OnClick="@(() => Select(Motor1))" OnSettingsClick="@(() => OpenSettings(Motor1))" />
        <Moteur Symbol="@Motor2" OnClick="@(() => Select(Motor2))" OnSettingsClick="@(() => OpenSettings(Motor2))" />
    </div>

    <div class="symbol-group">
        <h3>Fans</h3>
        <Fan Symbol="@Fan1" OnClick="@(() => Select(Fan1))" OnSettingsClick="@(() => OpenSettings(Fan1))" />
        <Fan Symbol="@Fan2" Size="120" OnClick="@(() => Select(Fan2))" OnSettingsClick="@(() => OpenSettings(Fan2))" />
    </div>

    <div class="symbol-group">
        <h3>Compass</h3>
        <div style="width: 120px; height: 120px;">
            <!-- Compass uses Symbol but might need wrapper if we want common features like selection border -->
            <!-- Compass.razor in previous step didn't use Wrapper for selection border but now it might? -->
            <!-- Checking Compass.razor: It does NOT use SymbolWrapper. -->
            <!-- So Select/Settings click might not work on Compass unless I add Wrapper there too. -->
            <!-- For now, just pass Symbol. -->
            <Compass Symbol="@Compass1" />
        </div>
    </div>

    <div class="symbol-group">
        <h3>Inputs & Progress</h3>
        <InputSymbol Symbol="@Input1" OnClick="@(() => Select(Input1))" OnSettingsClick="@(() => OpenSettings(Input1))" />
        <ProgressBar Symbol="@Progress1" Width="60" Height="150" OnClick="@(() => Select(Progress1))" OnSettingsClick="@(() => OpenSettings(Progress1))" />
    </div>
</div>

<ConfirmationModal IsVisible="@IsModalVisible" Title="Settings Confirmation" Message="@($"Are you sure you want to configure {TargetSettingsId}?")" OnConfirm="@OnConfirmSettings" OnCancel="@OnCancelSettings" />


